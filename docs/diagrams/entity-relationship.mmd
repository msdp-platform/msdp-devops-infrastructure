%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#2E8B57',
    'primaryTextColor': '#000000',
    'primaryBorderColor': '#1B5E20',
    'lineColor': '#FF6B35',
    'secondaryColor': '#4A90E2',
    'tertiaryColor': '#F5A623',
    'background': '#ffffff',
    'mainBkg': '#f8f9fa',
    'secondBkg': '#e9ecef',
    'tertiaryBkg': '#dee2e6',
    'entityBkg': '#ffffff',
    'entityBorder': '#2E8B57',
    'entityTextColor': '#000000',
    'attributeBkg': '#f0f8ff',
    'attributeBorder': '#4A90E2',
    'attributeTextColor': '#000000',
    'relationshipBkg': '#fff2cc',
    'relationshipBorder': '#F5A623',
    'relationshipTextColor': '#000000',
    'textColor': '#000000'
  },
  'er': {
    'diagramPadding': 35,
    'layoutDirection': 'TB',
    'minEntityWidth': 140,
    'minEntityHeight': 100,
    'entityPadding': 25,
    'stroke': '#2E8B57',
    'fill': '#ffffff',
    'fontSize': 16,
    'attributeFontSize': 14
  },
  'fontFamily': 'Segoe UI, Arial, sans-serif',
  'fontSize': 18,
  'fontWeight': '600'
}}%%
erDiagram
    USERS {
        uuid id PK "Primary Key"
        string email UK "Unique Email"
        string phone UK "Unique Phone"
        string password_hash "Encrypted Password"
        string first_name "First Name"
        string last_name "Last Name"
        date date_of_birth "Date of Birth"
        string profile_image_url "Profile Image"
        boolean is_verified "Email Verified"
        boolean is_active "Account Active"
        timestamp last_login_at "Last Login"
        timestamp created_at "Created Date"
        timestamp updated_at "Updated Date"
        timestamp deleted_at "Soft Delete"
    }
    
    USER_ROLES {
        uuid id PK "Role Assignment ID"
        uuid user_id FK "User Reference"
        enum role "User Role"
        uuid location_id FK "Location Scope"
        uuid granted_by FK "Granted By User"
        timestamp granted_at "Grant Date"
        timestamp expires_at "Expiry Date"
        boolean is_active "Role Active"
        timestamp created_at "Created Date"
    }
    
    LOCATIONS {
        uuid id PK "Location ID"
        string name "Location Name"
        enum type "Location Type"
        uuid parent_id FK "Parent Location"
        string country_code "Country Code"
        string timezone "Timezone"
        geometry coordinates "GPS Coordinates"
        geometry boundary "Service Boundary"
        jsonb metadata "Additional Data"
        boolean is_active "Location Active"
        timestamp created_at "Created Date"
        timestamp updated_at "Updated Date"
    }
    
    MERCHANTS {
        uuid id PK "Merchant ID"
        uuid user_id FK "Owner User"
        string business_name "Business Name"
        enum business_type "Business Type"
        text description "Business Description"
        string logo_url "Logo Image URL"
        string cover_image_url "Cover Image URL"
        uuid location_id FK "Business Location"
        text address "Business Address"
        geometry coordinates "GPS Coordinates"
        string phone "Contact Phone"
        string email "Contact Email"
        string website_url "Website URL"
        jsonb business_hours "Operating Hours"
        boolean is_verified "Business Verified"
        boolean is_active "Business Active"
        decimal rating "Average Rating"
        integer total_reviews "Total Reviews"
        timestamp created_at "Created Date"
        timestamp updated_at "Updated Date"
    }
    
    PRODUCTS {
        uuid id PK
        uuid merchant_id FK
        uuid category_id FK
        string name
        text description
        decimal price
        decimal compare_price
        decimal cost_price
        string sku
        string barcode
        jsonb images
        jsonb attributes
        integer inventory_quantity
        integer low_stock_threshold
        boolean is_available
        boolean is_featured
        integer sort_order
        timestamp created_at
        timestamp updated_at
    }
    
    ORDERS {
        uuid id PK
        string order_number UK
        uuid customer_id FK
        uuid merchant_id FK
        uuid delivery_partner_id FK
        enum status
        decimal subtotal
        decimal tax_amount
        decimal delivery_fee
        decimal service_fee
        decimal discount_amount
        decimal total_amount
        text delivery_address
        geometry delivery_coordinates
        text delivery_instructions
        timestamp estimated_delivery_time
        timestamp actual_delivery_time
        timestamp order_placed_at
        timestamp accepted_at
        timestamp ready_at
        timestamp picked_up_at
        timestamp delivered_at
        text notes
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }
    
    ORDER_ITEMS {
        uuid id PK
        uuid order_id FK
        uuid product_id FK
        integer quantity
        decimal unit_price
        decimal total_price
        text special_instructions
        timestamp created_at
    }
    
    PAYMENTS {
        uuid id PK
        uuid order_id FK
        enum payment_method
        enum status
        decimal amount
        string currency
        string gateway_transaction_id
        jsonb gateway_response
        timestamp initiated_at
        timestamp completed_at
        timestamp failed_at
        text failure_reason
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }
    
    DELIVERY_PARTNERS {
        uuid id PK
        uuid user_id FK
        string vehicle_type
        string vehicle_number
        string license_number
        string insurance_number
        boolean is_verified
        boolean is_available
        geometry current_location
        decimal rating
        integer total_deliveries
        timestamp created_at
        timestamp updated_at
    }
    
    DELIVERY_TRACKING {
        uuid id PK
        uuid order_id FK
        uuid delivery_partner_id FK
        geometry location
        string status
        timestamp timestamp
        decimal accuracy
        decimal speed
        decimal heading
        timestamp created_at
    }
    
    REVIEWS {
        uuid id PK
        uuid order_id FK
        uuid reviewer_id FK
        uuid merchant_id FK
        uuid delivery_partner_id FK
        integer merchant_rating
        integer delivery_rating
        integer food_rating
        text merchant_review
        text delivery_review
        text food_review
        jsonb images
        boolean is_approved
        uuid moderated_by FK
        timestamp moderated_at
        timestamp created_at
        timestamp updated_at
    }
    
    NOTIFICATIONS {
        uuid id PK
        uuid user_id FK
        enum type
        enum channel
        string title
        text message
        jsonb data
        timestamp sent_at
        timestamp delivered_at
        timestamp read_at
        timestamp failed_at
        string status
        integer retry_count
        integer max_retries
        timestamp created_at
        timestamp updated_at
    }
    
    ANALYTICS_EVENTS {
        uuid id PK
        string event_type
        uuid user_id FK
        string session_id
        jsonb properties
        timestamp timestamp
        timestamp created_at
    }

    USERS ||--o{ USER_ROLES : "has roles"
    USERS ||--o{ ORDERS : "places orders"
    USERS ||--o{ MERCHANTS : "owns business"
    USERS ||--o{ DELIVERY_PARTNERS : "is partner"
    USERS ||--o{ REVIEWS : "writes reviews"
    USERS ||--o{ NOTIFICATIONS : "receives"
    USERS ||--o{ ANALYTICS_EVENTS : "generates events"
    
    LOCATIONS ||--o{ LOCATIONS : "parent-child"
    LOCATIONS ||--o{ MERCHANTS : "located in"
    LOCATIONS ||--o{ DELIVERY_ZONES : "contains zones"
    
    MERCHANTS ||--o{ PRODUCTS : "sells products"
    MERCHANTS ||--o{ ORDERS : "receives orders"
    MERCHANTS ||--o{ REVIEWS : "receives reviews"
    
    PRODUCTS ||--o{ ORDER_ITEMS : "included in orders"
    CATEGORIES ||--o{ PRODUCTS : "categorizes"
    
    ORDERS ||--o{ ORDER_ITEMS : "contains items"
    ORDERS ||--o{ PAYMENTS : "has payments"
    ORDERS ||--o{ DELIVERY_TRACKING : "tracks delivery"
    ORDERS ||--o{ REVIEWS : "generates reviews"
    
    DELIVERY_PARTNERS ||--o{ DELIVERY_TRACKING : "tracked by"
    DELIVERY_PARTNERS ||--o{ ORDERS : "delivers orders"
    DELIVERY_PARTNERS ||--o{ REVIEWS : "receives reviews"
